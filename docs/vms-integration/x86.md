{% hint style="warning" %}
Is now in the development stage.
{% endhint %}

# Общее описание

## Архитектура виртуальных машин ECHO

Предполагается поддержка в **ECHO** несколько виртуальных машин. На данный момент это виртуальная машина **Ethereum** и виртуальная машина **x86**.

Для унификации работы с существующими и подключения перспективных виртуальных машин разработана данная архитектура работы с виртуальными машинами со стороны системы **ECHO**.

### Общая схема работы VMs

Каждая виртуальная машина поддерживает три основные логические операции:

* создание контракта
* выполнение метода контракта
* удаление контракта

Также реализация виртуальной машины должна поддерживать следующие вспомогательные операции:

* конвертация идентификаторов ECHO в формат виртуальной машины и обратно
* конвертация набора параметров из JSON строки в формат виртуальной машины и обратно
* проверка кода контракта \(и, опционально, идентификатора метода контракта\) на соответствие формату данной виртуальной машины

Инициализация виртуальной машины происходит с помощью следущих параметров:

* хэш состояния виртуальной машины
* указатель на абстрактный интерфейс реализации NoSQL БД
* указатель на абстрактный интерфейс доступа к Blockchain БД

### Операции с виртуальной машиной

При работе с виртуальной машиной, в каждую операцию передается контекст,
содержащий следующие параметры:

* индетификатор аккаунта, производящего операцию
* идентификатор передаваемого в операцию актива (asset_id)
* количество передаваемого актива
* ...

Дополнительные параметры операций приведены ниже.

### Создание контракта

x86_vm:

Создание контракта (x86_vm, evm) с точки зрения wallet_api:

* индетификатор аккаунта, производящего операцию 
* идентификатор передаваемого в операцию актива (asset_id)
* код контракта
* актив предназначенный для выполнения контракта
* актив непосредственно самого контракта (деньги котракта, которые он может использовать)
* параметры сети (broadcast, ...)

Для создания контракта в методе create виртуальной машины x86 передаются следующие аргументы:
Есть два варианта:
1. Вариант:
* код контракта
* сумма, которая передается на аккаунт контракта

2. Вариант:
* ид транзакции
* сумма, которая передается на аккаунт контракта

### Выполнение контракта

Выполнение контракта (x86_vm, evm) с точки зрения wallet_api:

* индетификатор аккаунта, производящего операцию 
* id контракта
* строка из параметров, передаваемых контракту 
* параметры сети

Для выполнения контракта в методе execute виртуальной машины x86 передаются следующие аргументы:
* id контракта
* аргменты для точки входа контракта (hash вызываемой функции, количество передаваемых аргументов, строки, в которых содержатся сами аргументы)

### Удаление контракта

Удаление контракта со стороны x86:
Несколько вариантов:
1. Удаление контракта из кода (код хранится не в транзакциях):

* создается системный вызов для удаления контракта
* если код хранится в транзакции, то сделать контракт после вызова delete contract не активным -> где-то должна содержаться информация о том, активный ли контракт

2. Удаление контракта, как api метод:

* передается индетификатор аккаунта, производящего операцию
* передается id контракта, который должен быть удален
 
### Результат выполнения операции (создание/выполнение/удаление)

Результаты выполнения для x86:
1. Создание:
* возвращается объект result_contract, в котором следующая находится сопутствующая информация о контракте (код, регистрант, ...)
2. Выполнение:
* возвращается объект result_contract, в котором находится инфомарция об успешном выполнении, либо ошибках

### Хэши состояния машины

### Хранение кода контрактов

Для x86 два варианта:
1. транзакции
2. база

### Хранение состояния контрактов

Для x86:
* объект result_contract в базе echo

### Работа с газом

### Работа с blockchain из кода контракта

Для x86:
Создаются системные вызовы для определенных операций на чейне, к примеру transfer активов с одного контракта на другой:
Аргменты этого вызова:
* id контракта, для которого производится перевод
* сумма актива

На номер созданного системного вызова transfer будет замаплены действия, к примеру, по создании транзакции такого перевода и непосредственного ее отправки