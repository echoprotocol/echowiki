# Описание интеграции EVM в echo

## Общая схема

`EthBitState` содержит 2 базы:

* `m_state` - содержит контракты, их код и т.д.

* `state_results` - содержит резльтаты создания и вызовов контрактов. Не хравнится в базе graphene для уменьшения потребления оперативной памяти

## Хэши состояния машины

В блоке хранятся:

* `state_root_hash` - хэш состояния базы контрактов(`m_state` выше)

* `result_root_hash` - хэш состояния базы результатов(`state_result` выше)

Оба - хэши корня (`root`) БД.

## Указатель на абстрактный интерфейс доступа к Blockchain БД

В текущей реализации `ethBitState` содержит `database`

## Операции с виртуальной машиной

При работе с виртуальной машиной, в каждую операцию передается контекст,
содержащий следующие параметры:

* `fee` - комиссия в виде суммы с идентификатором актива(есть у всех операций)

* `registrar` - индетификатор аккаунта, производящего операцию

* `value` - количество передаваемого актива

* `asset_id` - идентификатор передаваемого в операцию актива

* `gas` - количество валюты, выделяемое на выполнение (предположительно, будет удалено)

* `gasPrice` - цена `gas` (будет удалено)

* `code` - байткод смартконтракта

Дополнительные параметры операций приведены ниже.

### Создание контракта

Создание смартконтракта происходит с помощью `contract_operation` и параметрами, описаными выше.

### Выполнение контракта

Содержит все параметры, описаные выше, а так же:

* `receiver` - идентификатор вызываемого контракта

* `code` - содержит `hash` вызываемого метода и закодированные в строку параметры сразу за ним.

### Удаление контракта

При удалении контракта он удаляется в `State` - на стороне эфира. В базе `echo` в объекте контракта проставляется флаг `suicided`, отображающий, что контракт удален

## Хранение контрактов

`EthBitState` содержит `result_db`, хранящую результаты. В `State`, от которого он наследуется - имеются поля `m_db` для хранения кода и `m_state` для хранения состояния контрактов.

### Хранение кода

Код хранится `State` в `m_db`, которая представляет собой `OverlayDB`(`key-value база`)

### Хранение состояния контрактов

Состояние контрактов хранится `State` в `m_state` типа `SecureTrieDB` - древовидная бд(`merkle tree`), основанная на `OverlayDB`

### Результат выполнения операции

В данный момент результат выполнения имеет тип `result_execute_object`, записывается в `result_db`. При этом обновляется хэш и записывается в следующий блок.

`result_execute_object` состоит из `execution_result` и `transaction_receipt` имеет следующую структуру:

```cpp
struct execution_result {
    std::string excepted;
    std::string new_address;
    std::string output;
    std::string code_deposit;
    unsigned deposit_size;
    std::string gas_for_deposit;
};
```

```cpp
struct transaction_receipt {
    std::string status_code;
    std::string gas_used;
    std::string bloom;
    std::vector<log_entry> log;
};
```

## Работа с газом

Под вопросом. На текущий момент `gas` и `gasPrice` указываются пользователем в операции

## Работа с blockchain из кода контракта

Для добавления функционала в `solidity` необходимо добавлять опкоды в компилятор, интерпретатор и саму виртуальную машину.